<template>
  <div class="app-container calendar-list-container">
    <div class="filter-container">
      <el-input v-model="searchValue" style="width: 200px;"></el-input>
      <el-button class="filter-item" @click="handleSearch()" type="promary">搜索</el-button>
      <el-button class="filter-item" @click="handleCreate" type="primary" icon="el-icon-edit">{{$t('common.add')}}</el-button>
    </div>

    <el-dialog :title="$t('common.add') + $t('common.space') + $t('role.role')" :visible.sync="dialog.dialogVisible" @open="dialog.contentVisible = true" @closed="dialog.contentVisible = false">
      <create-role v-if="dialog.contentVisible" :status="dialog.status" :id="dialog.id" @close="handleClose"></create-role>
    </el-dialog>

    <table-custom :module="table.module" :cols="table.cols" :btns="table.btns" @operation="handleOperation"></table-custom>
  </div>

</template>

<script>

import * as api from '@/services/role'
import * as api2 from '@/services/resource'
import createRole from './modal/createRole.vue'
import tableCustom from '../user/table.vue'
export default {
  components: {
      createRole,
      tableCustom
  },
  data () {
    return {
      searchValue: '',
      dialog: {
        dialogVisible: false,
        contentVisible: false,
        status: 'create',
        id: ''
      },
      table: {
          module: 'role',
          cols: [
              {
                  prop: 'id',
                  label: 'ID',
                  width: '180',
                  sortable: 'false'
              },
              {
                  prop: 'name',
                  label: this.$t('role.name'),
                  width: '180',
                  sortable: 'custom'
              }
          ],
          btns: [
              {
                  type: 'edit',
                  name: this.$t('common.edit'),
                  color: 'default'
              },
              {
                  type: 'delete',
                  name: this.$t('common.delete'),
                  color: 'danger'
              }
          ]
      }
    }
  },
  created () {
    this.initTable()
  },
  asyncData({store}){
    return store.dispatch(`${this.table.module}/getList`, {
        page: 1,
        pageSize: 5,
        filter: '',
        sortBy: '',
        sort: ''
    })
  },
  methods: {
    initTable (isSearch) {
      if (isSearch) {
        this.$store.dispatch(`${this.table.module}/setPagination`, {page: 1});
      }
      this.$store.dispatch(`${this.table.module}/getList`).then((e)=>{
        //TODO: 出错的提示
        this.$formatMessage(e, '获取用户列表', 'none');
      })
    },
    handleSearch () {
      this.$store.dispatch(`${this.table.module}/setPagination`, {filter: this.searchValue});
      this.initTable();
    },
    handleCreate () {
      this.dialog.status = 'create';
      this.dialog.id = '';
      this.dialog.dialogVisible = true
    },
    handleEdit (id) {
      this.dialog.status = 'edit';
      this.dialog.id = id;
      this.dialog.dialogVisible = true
    },
    handleClose (fresh) {
      if (fresh) {
        this.initTable();
      }
      this.dialog.dialogVisible = false
    },
    handleDelete (id, row) {
      this.$confirm('此操作将永久删除该角色, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.$store.dispatch(`${this.table.module}/delete`, id).then(() => {
            this.initTable()
            this.$message({
              type: 'success',
              message: '删除成功!'
            });
          })
          
        }).catch(() => {
          // 取消删除       
        });
    },
    handleOperation ({type, row}) {
        switch(type){
            case 'edit':
                this.handleEdit(row.id);
                break;
            case 'delete':
                this.handleDelete(row.id, row);
                break;
        }
    }
  }
}
</script>
